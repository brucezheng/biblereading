<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Finish Reading the Bible!</title>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="bookVerses.js"></script>
  <script src="dateUtils.js"></script>
  <style>
    /* Main View */
    button {
      font-size: 11pt;
    }
    .scriptureContainer {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: space-evenly;
      max-width: 1100px; 
      margin: auto;
    }
    .scriptureQuote {
      font-style: italic; 
      width: 300px;
      padding: 24px;
    }
    .textCentered {
      text-align: center;
    }
    .scriptureQuote .citation {
      font-style: normal;
      font-weight: bold;
      text-align: right;
      padding-top: 8px;
    }
    .mainContentContainer {
      max-width: 1000px; 
      margin: auto;
      padding: 24px;
    }
    .stepHeader {
      border: 2px solid black;
      font-size: 24pt;
      margin-bottom: 6px;
      margin-top: 24px;
      text-align: center;
      width: 36px;
    }
    .stepContent {
      padding: 12px 24px;
    }
    .stepDescription {
      font-style: italic;
      margin-bottom: 8px;
    }
    .bookSelectionContainer {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      margin-left: -12px;
      margin-bottom: 8px;
    }
    .bookSelection {
      align-content: flex-start;
      display: flex;
      flex-direction: column;
      flex-wrap: wrap;
      max-height: 300px;
    }
    .selectionHeader {
      font-weight: bold;
      margin: 12px 0 4px 36px;
      width: 100%;
    }
    .selectionSpacer {
      height: 20px;
      width: 20px;
    }
    .bookCheckbox {
      margin-left: 48px;
    }
    .checkboxLabel {
      display: inline-block;
      user-select: none;
    }
    @media (max-width: 900px) {
      .stepHeader {
        margin-top: 12px;
      }
      .stepHeader:first-of-type {
        margin-top: 0;
      }
    }
    @media (max-width: 600px) {
      .scriptureQuote {
        padding: 12px;
      }
      .scriptureQuote:last-of-type {
        padding: 12px 12px 0;
      }
      .selectionSpacer {
        display: none;
      }
      .selectionHeader {
        margin: 12px 0 4px 14px;
      }
      .bookSelection {
        max-height: 400px;
      }
      .bookCheckbox {
        margin-left: 16px;
      }
    }
    .dateSuggestionButton {
      margin-top: 8px;
    }
    .datePickerContainer {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
    }
    .datePicker {
      margin-bottom: 8px;
      margin-right: 24px;
    }
    .errorMessage {
      color: red;
      font-style: italic;
    }
    #extraOptionsEmptyText {
      color: #b3b3b3;
      font-style: italic;
    }
    .extraOptionsContainer {
      display: flex;
      flex-direction: row;
    }
    .extraOptionsCheckbox {
      margin-left: 4px;
    }
    #planSummaryText {
      margin-bottom: 8px;
    }
    /* Reading Plan View */
    @media (max-width: 450px) {
      h1 {
        font-size: 21pt;
      }
      .mainContentContainer {
        padding: 16px;
      }
      .stepContent {
        padding: 12px;
      }
      .bookSelection {
        max-height: unset;
      }
    }
    .planHeader {
      border: 2px solid black;
      font-size: 24pt;
      margin-bottom: 6px;
      margin-top: 24px;
      padding: 0 4px;
      text-align: center;
      width: 72px;
    }
    .bibleReadingPlanContainer{
      width: 100%;
    }
    .printedReadingPlanContainer{
      display: none;
      margin-top: 40px;
      width: 100%;
    }
    .hiddenForMeasurement {
      left: -300px;
      visibility: hidden
    }
    .readingPlanPage {
      align-content: center;
      display: flex;
      flex-direction: column;
      flex-wrap: wrap;
      margin-bottom: 48px;
    }
    .readingPlanYearHeader.startOfColumn {
      padding: 0;
      margin-top: -4px;
    }
    .readingPlanYearHeader {
      font-size: 28pt;
      font-weight: bold;
      padding: 5px 0 0;
      width: 250px;
    }
    .readingPlanMonth {
      margin: 12px 0;
    }
    .readingPlanMonthHeader {
      font-size: 16pt;
      font-weight: bold;
      text-decoration: underline;
      padding: 8px 0;
      width: 250px;
    }
    .readingPlanMonthHeader.startOfColumn {
      padding: 0 0 8px;
    }
    .readingPlanEntry {
      display: flex;
      flex-direction: row;
      font-size: 12pt;
      padding-bottom: 2px;
      width: 250px;
    }
    .readingPlanEntryDate {
      font-weight: bold;
      margin-right: 3px;
    }
    .planActionButtonContainer {
      display: flex;
      flex-direction: row;
      justify-content: center;
      margin-top: 16px;
    }
    .planActionButtonContainer button {
      margin: 24px;
    }
    @media print {
      .planActionButtonContainer {
        display: none;
      }
      .bibleReadingPlanContainer {
        display: none;
      }
      .readingPlanPage {
        margin-left: 30px;
      }
      .readingPlanPage:last-of-type {
        margin-bottom: 0;
      }
      .printedReadingPlanContainer {
        display: block;
      }
    }
  </style>
</head>
<body>
  <div id="measuringSpace"></div>
  <div id="mainView">
    <div style="width: 100%; text-align: center; padding-top: 12px;">
      <h1>
      Finish Reading the Bible!
      </h1>
    </div>
    <div style="width: 100%">
      <div class="scriptureContainer">
        <div class="scriptureQuote">
          Blessed is the man <br>
          &nbsp;&nbsp;&nbsp;&nbsp;who walks not in the counsel of the wicked, <br>
          nor stands in the way of sinners, <br>
          &nbsp;&nbsp;&nbsp;&nbsp;nor sits in the seat of scoffers;<br>
          but his delight is in the law of the Lord,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;and on his law he meditates day and night.
          <div class="citation">Psalm 1:1-2</div>
        </div>
        <div class="scriptureQuote">
          For the word of God is living and active, sharper than any two-edged sword, piercing to the division of soul and of spirit, of joints and of marrow, and discerning the thoughts and intentions of the heart.
        <div class="citation">Hebrews 4:12</div>
        </div>
        <div class="scriptureQuote">
          How sweet are your words to my taste,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;sweeter than honey to my mouth!<br>
          Through your precepts I get understanding;<br>
          &nbsp;&nbsp;&nbsp;&nbsp;therefore I hate every false way.<br>
          Your word is a lamp to my feet<br>
          &nbsp;&nbsp;&nbsp;&nbsp;and a light to my path.
          <div class="citation">Psalm 119:103-105</div>
      </div>
    </div>
    </div>
    <div style="width: 100%">
      <div class="mainContentContainer">
        <div class="stepHeader">1</div>
        <div class="stepContent">
          <div class="stepDescription">Pick the books you are going to read</div>
          <button id="checkAllButton" class="ui-button ui-corner-all">Check all</button>
          <button id="uncheckAllButton" class="ui-button ui-corner-all">Uncheck all</button>
          <div class="bookSelectionContainer">
            <div style="display: flex; flex-direction: column;">
              <div class="selectionHeader" selection="oldTestamentSelection">Old Testament</div>
              <div class="bookSelection" id="oldTestamentSelection"></div>
            </div>
            <div class="selectionSpacer"></div>
            <div style="display: flex; flex-direction: column">
              <div class="selectionHeader" selection="newTestamentSelection">New Testament</div>
              <div class="bookSelection" id="newTestamentSelection"></div>
            </div>
          </div>
          <div id="numberVersesText" style="display: none;">
            You need to read
            <span id="numberVersesCount" style="font-weight: bold;"></span>
            over
            <span id="numberChaptersCount" style="font-weight: bold;"></span>
          </div>
        </div>
        <div class="stepHeader">2</div>
        <div class="stepContent">
        <div class="stepDescription">Set your starting and ending date</div>
          <div class="datePickerContainer">
            <div class="datePicker">Starting date: <input id="startingDate" type="date"></div>
            <div class="datePicker">Ending date: <input id="endingDate" type="date"></div>
          </div>
          <div id="dateErrorMessage" style="display: none;" class="errorMessage"></div>
          <div id="planDurationText" style="display: none;">
            Your plan will take <span id="planDurationDays" style="font-weight: bold;"></span>
          </div>
          <button id="suggestStartingDateButton"
                  style="display: none;"
                  class="dateSuggestionButton ui-button ui-corner-all">
            Suggest a starting date
          </button>
          <button id="suggestEndingDateButton"
                  style="display: none;"
                  class="dateSuggestionButton ui-button ui-corner-all">
            Suggest an ending date
          </button>
        </div>
        <div class="stepHeader">3</div>
        <div class="stepContent">
        <div class="stepDescription">Select extra options</div>
        <span id="extraOptionsEmptyText">No extra options available</span>
        <div class="extraOptionsContainer">
          <div class="extraOptionsCheckbox"
               id="parallelPsalmsCheckbox"
               style="display: none;">
            <input type="checkbox" />
            <span class="checkboxLabel">Psalms in parallel</span>
          </div>
          <div class="extraOptionsCheckbox"
               id="dailyPsalmsCheckbox"
               style="display: none;">
            <input type="checkbox" />
            <span class="checkboxLabel">Psalms every day</span>
          </div>
        </div>
        </div>
        <div class="stepHeader">4</div>
        <div class="stepContent">
        <div id="planSummaryText" style="display: none;">
          You're going to read an average of 
          <span id="summaryDailyVerses" style="font-weight: bold;"></span>
          daily (which should take about 
          <span id="summaryDailyTime" style="font-weight: bold;"></span>
          )
        </div>
        <button id="submitButton" class="ui-button ui-corner-all">Get your plan</button>
        </div>
      </div>
    </div>
  </div>
  <div id="readingPlanView" style="display: none;">
    <div style="width: 100%; text-align: center; padding-top: 12px;">
      <span class="planHeader">Reading Plan</span>
    </div>
    <div class="planActionButtonContainer">
      <button id="modifyButton" class="ui-button ui-corner-all">Modify plan</button>
      <button id="printButton" class="ui-button ui-corner-all">Print</button>
    </div>
    <div class="bibleReadingPlanContainer"></div>
    <div class="printedReadingPlanContainer"></div>
  </div>
  <script>
    const READING_PLAN_COLUMN_SIZE = 300;
    const AVERAGE_WORDS_PER_VERSE = 25;
    const AVERAGE_MINUTES_PER_VERSE_MIN = AVERAGE_WORDS_PER_VERSE / 300;
    const AVERAGE_MINUTES_PER_VERSE_MAX = AVERAGE_WORDS_PER_VERSE / 100;
    const GET_ESTIMATED_ELEMENT_HEIGHT = true;

    const READING_PLAN_YEAR_HEADER_HEIGHT = 48;
    const READING_PLAN_MONTH_HEADER_HEIGHT = 40;
    const READING_PLAN_YEAR_HEADER_START_OF_COLUMN_HEIGHT = 39;
    const READING_PLAN_MONTH_HEADER_START_OF_COLUMN_HEIGHT = 32;
    const READING_PLAN_ENTRY_LINE_HEIGHT = 18;
    const READING_PLAN_ENTRY_PADDING = 2;

    const today = getDateInputVal(new Date())
    const suggestedVersesPerDay = (totalNumberVerses / 365.0);

    let checkedBooks = new Set();
    let numberVerses = 0;
    let numberChapters = 0;
    let startingDate = new Date(today);
    let endingDate = null;
    let bibleReadingPlan = [];
    let planOptions = {
      parallelPsalms: false,
      dailyPsalms: false,
    };

    oldTestamentBooks.forEach((name) =>
        $('#oldTestamentSelection').append(createBookCheckbox(name)));
    newTestamentBooks.forEach((name) =>
        $('#newTestamentSelection').append(createBookCheckbox(name)));
    $('.bookSelection').each(function() {
      const lastChild = $(this).children().last();
      const newWidth =
          lastChild.position().left - $(this).position().left +
              lastChild.outerWidth(true);
      if (newWidth > $(this).outerWidth()) {
        $(this).width(newWidth);
      }
    })

    $('#startingDate').val(today);

    $('#submitButton').button({
      disabled: true
    });

    function createElement(tag, classList=[]) {
      const element = document.createElement(tag);
      for (const className of classList) {
        element.classList.add(className);
      }
      return element;
    }

    function createBookCheckbox(labelText) {
      const checkbox = createElement('div', ['bookCheckbox']);
      const label = createElement('div', ['checkboxLabel']);
      const input = createElement('input');
      input.type = 'checkbox';
      label.innerHTML = labelText;
      checkbox.append(input);
      checkbox.append(label);
      return checkbox;
    }

    function createReadingPlanEntry(entry) {
      const result = createElement('div', ['readingPlanEntry']);
      const monthDay = createElement('div', ['readingPlanEntryDate']);
      monthDay.innerHTML = getMonthDayString(entry.date) + ': ';
      const reading = createElement('div', ['readingPlanEntryReading']);
      reading.innerHTML = entry.reading;
      result.append(monthDay);
      result.append(reading);
      return result;
    }

    function createReadingPlanMonthElements(monthPlan, yearHeader=null) {
      const result = [];
      if (yearHeader) {
        const yearHeaderEl = createElement('div', ['readingPlanYearHeader']);
        yearHeaderEl.innerHTML = yearHeader;
        result.push(yearHeaderEl);
      }
      const monthHeader = createElement('div', ['readingPlanMonthHeader']);
      monthHeader.innerHTML = monthNames[monthPlan.month];
      result.push(monthHeader);
      for (const entry of monthPlan.dailyReadings) {
        result.push(createReadingPlanEntry(entry));
      }
      return result;
    }

    function toggleCheckbox(checkbox, state=null) {
      checkbox.prop(
          'checked', state !== null ? state : !checkbox.prop('checked'));
    }

    function toggleAllCheckboxes(state=null) {
      $('.bookCheckbox input').each(function() {
        toggleCheckbox($(this), state);
      });
      onCheckboxToggled();
    }

    function onCheckboxToggled() {
      checkedBooks.clear();
      $('.bookCheckbox input').each(function() {
        if ($(this).prop('checked')) {
          const bookName = $(this).parent().find('.checkboxLabel').html();
          checkedBooks.add(bookName);
        }
      });
      updateNumberVersesText();
      updateAvailableExtraOptions();
      updateSubmitButtonEnabled();
      updateDateSuggestionButtons();
    }

    function updateNumberVersesText() {
      numberVerses = getNumberVerses(checkedBooks);
      numberChapters = getNumberChapters(checkedBooks);
      if (numberVerses === 0) {
        $('#numberVersesText').css('display', 'none');
        return;
      }
      $('#numberChaptersCount').html(
          `${numberChapters} ${numberChapters > 1 ? 'chapters' : 'chapter'}`);
      $('#numberVersesCount').html(`${numberVerses} verses`);
      $('#numberVersesText').css('display', 'block');
    }

    function getDaysDate(days) {
      return new Date(days * 24 * 60 * 60 * 1000);
    }

    function getDateDays(date) {
       return date / 1000 / 60 / 60 / 24;
    }

    function getDateInputVal(date) {
      const day = ("0" + date.getDate()).slice(-2);
      const month = ("0" + (date.getMonth() + 1)).slice(-2);
      return date.getFullYear()+"-"+(month)+"-"+(day) ;
    }

    function checkDateValidity() {
      updateSubmitButtonEnabled();
      if (!startingDate || !endingDate) {
        return hideDateErrorMessage();
      }
      if (endingDate < startingDate) {
        return setDateErrorMessage('Ending date cannot be before starting date.');
      }
      return hideDateErrorMessage();
    }

    function areDatesValid() {
      return startingDate && endingDate && endingDate >= startingDate;
    }

    function updateAvailableExtraOptions() {
      const showParallelPsalms =
          checkedBooks.has('Psalms') && checkedBooks.size > 1;
      if (showParallelPsalms) {
        $('#parallelPsalmsCheckbox').show();
      } else {
        planOptions.parallelPsalms = false;
        $('#parallelPsalmsCheckbox input').prop('checked', false);
        $('#parallelPsalmsCheckbox').hide();
      }
      // TODO: Refactor code to avoid duplicate code like this.
      const showDailyPsalms = planOptions.parallelPsalms;
      if (showDailyPsalms) {
        $('#dailyPsalmsCheckbox').show();
      } else {
        planOptions.dailyPsalms = false;
        $('#dailyPsalmsCheckbox input').prop('checked', false);
        $('#dailyPsalmsCheckbox').hide();
      }
      const anyAvailable = showParallelPsalms || showDailyPsalms;
      anyAvailable ?
        $('#extraOptionsEmptyText').hide() :
        $('#extraOptionsEmptyText').show();
    }

    function parallelPsalmsToggled() {
      planOptions.parallelPsalms =
          $('#parallelPsalmsCheckbox input').prop('checked');
      updateAvailableExtraOptions();
      updateBibleReadingPlan();
    }

    function dailyPsalmsToggled() {
      planOptions.dailyPsalms =
          $('#dailyPsalmsCheckbox input').prop('checked');
      updateAvailableExtraOptions();
      updateBibleReadingPlan();
    }

    function updateBibleReadingPlan() {
      if (!areDatesValid() || checkedBooks.size === 0) {
        bibleReadingPlan = [];
        return;
      }
      bibleReadingPlan =
          getBibleReadingPlan(
              startingDate, endingDate, checkedBooks, planOptions);
    }

    function hideDateErrorMessage() {
      $('#dateErrorMessage').css('display', 'none');
    }

    function setDateErrorMessage(errorMessage) {
      $('#dateErrorMessage').html(errorMessage);
      $('#dateErrorMessage').css('display', 'block');
    }

    function updatePlanDurationText() {
      if (!areDatesValid()) {
        $('#planDurationText').css('display', 'none');
        return;
      }
      const planDuration =
          getDateDays(new Date(endingDate - startingDate)) + 1;
      $('#planDurationDays').html(
          `${planDuration} ${planDuration > 1 ? 'days' : 'day'}`);
      $('#planDurationText').css('display', 'block');
    }

    function getSuggestedPlanDuration() {
      return Math.round(numberVerses / suggestedVersesPerDay);
    }

    function getSuggestedDate(buttonId) {
      if (buttonId === '#suggestStartingDateButton') {
        return getSuggestedStartingDate();
      }
      return getSuggestedEndingDate();
    }

    function getSuggestedStartingDate() {
      if (!endingDate) {
        return null;
      }
      const suggestedStartingDate = new Date(startingDate);
      return new Date(
          suggestedStartingDate.setDate(
                suggestedStartingDate.getDate() - getSuggestedPlanDuration()));
    }

    function getSuggestedEndingDate() {
      if (!startingDate) {
        return null;
      }
      const suggestedEndingDate = new Date(startingDate);
      return new Date(
          suggestedEndingDate.setDate(
                suggestedEndingDate.getDate() + getSuggestedPlanDuration()));
    }

    function updateDateSuggestionButtons() {
      if (numberChapters === 0 || (!startingDate && !endingDate)) {
        $('#suggestStartingDateButton').css('display', 'none');
        $('#suggestEndingDateButton').css('display', 'none');
      } else if (
          !startingDate && endingDate && 
              getSuggestedStartingDate() >= new Date(today)) {
        $('#suggestStartingDateButton').css('display', 'block');
        $('#suggestEndingDateButton').css('display', 'none');
      } else {
        $('#suggestStartingDateButton').css('display', 'none');
        $('#suggestEndingDateButton').css('display', 'block');
      }
    }

    function updatePlanSummaryText() {
      if (!areDatesValid() || numberVerses === 0) {
        $('#planSummaryText').css('display', 'none');
        return;
      }
      const planDuration = getDateDays(new Date(endingDate - startingDate)) + 1;
      const dailyVerses = numberVerses / planDuration;
      const dailyReadingTimeMin = dailyVerses * AVERAGE_MINUTES_PER_VERSE_MIN;
      const dailyReadingTimeMax = dailyVerses * AVERAGE_MINUTES_PER_VERSE_MAX;
      $('#planSummaryText').css('display', 'block');
      $('#summaryDailyVerses').html(
          `${dailyVerses.toFixed(0)} verses`);
      $('#summaryDailyTime').html(
          `${dailyReadingTimeMin.toFixed(0)}` +
              `-${dailyReadingTimeMax.toFixed(0)} minutes`);
    }

    function updateSubmitButtonEnabled() {
      updatePlanSummaryText();
      updateBibleReadingPlan();
      $('#submitButton').button(
          'option', 'disabled', bibleReadingPlan.length === 0);
    }

    function populatePlanView() {
      const segmentedPlan = [];
      let currentYearPlan;
      let currentMonthPlan;
      let totalNumberMonths = 0;
      for (const entry of bibleReadingPlan) {
        const entryYear = entry.date.getFullYear();
        const entryMonth = entry.date.getUTCMonth();
        if (!currentMonthPlan || entryMonth != currentMonthPlan.month) {
          if (currentMonthPlan && currentYearPlan) {
            currentYearPlan.monthlyReadings.push(currentMonthPlan);
            totalNumberMonths += 1;
          }
          currentMonthPlan = {month: entryMonth, dailyReadings: []};
        }
        if (!currentYearPlan || entryYear != currentYearPlan.year) {
          if (currentYearPlan) {
            segmentedPlan.push(currentYearPlan);
          }
          currentYearPlan = {year: entryYear, monthlyReadings: []};
        }
        currentMonthPlan.dailyReadings.push(
            {date: entry.date, reading: entry.reading});
      }
      currentYearPlan.monthlyReadings.push(currentMonthPlan);
      totalNumberMonths += 1;
      segmentedPlan.push(currentYearPlan);

      const renderedPlanElements = [];
      for (const yearPlan of segmentedPlan) {
        let firstMonth = true;
        for (const monthPlan of yearPlan.monthlyReadings) {
          let yearHeader = null;
          if (segmentedPlan.length > 1 && firstMonth) {
            firstMonth = false;
            yearHeader = yearPlan.year;
          }
          const renderedPlan =
              createReadingPlanMonthElements(monthPlan, yearHeader);
          renderedPlanElements.push(renderedPlan);
        }
      }

      const viewPageHeight = Math.max(500, window.innerHeight - 175);
      const viewNumberColumns =
          Math.max(1, Math.floor(window.innerWidth / 300));

      const renderedPlanElementsCopy =
          renderedPlanElements.map(
              renderedPlan => renderedPlan.map(
                  element => element.cloneNode(true)));

      $('.bibleReadingPlanContainer').empty();
      new ReadingPlanPages(
              renderedPlanElements, viewPageHeight, viewNumberColumns)
              .getPages()
              .forEach(
                  planPage =>
                      $('.bibleReadingPlanContainer').append(planPage));
      window.scrollTo(0, 0);

      $('.printedReadingPlanContainer').empty();
      new ReadingPlanPages(
              renderedPlanElementsCopy, 955, 3, /* firstPageHeight */ 875)
              .getPages()
              .forEach(
                  planPage =>
                      $('.printedReadingPlanContainer').append(planPage));
    }

    class ReadingPlanPages {
      /**
       * @param {!Array<!Array<!Element>>} renderedMonthPlans
       * @param {number} pageHeight
       * @param {number} numberPageColumns
       */
      constructor(
          renderedMonthPlans,
          pageHeight,
          numberPageColumns,
          firstPageHeight=null) {
        this.pageHeight = pageHeight;
        this.firstPageHeight = firstPageHeight || pageHeight;
        this.numberPageColumns = numberPageColumns;
        this.pages = [];
        this.pageColumnHeights = [];

        this.addPage_();
        renderedMonthPlans.forEach(monthPlan => this.addMonthPlan_(monthPlan));
      }

      getPages() {
        return this.pages;
      }

      addMonthPlan_(monthPlan) {
        let pageIndex = this.pages.length - 1;
        if (!this.canAddMonthPlanToPage_(pageIndex, monthPlan)) {
          this.addPage_();
          pageIndex += 1;
        }
        this.addMonthPlanToPage_(pageIndex, monthPlan);
      }

      addPage_() {
        const newPage = createElement('div', ['readingPlanPage']);
        this.pages.push(newPage);
        const newPageIndex = this.pages.length - 1;
        $(newPage).css('height', `${this.getPageHeight_(newPageIndex)}px`);
        const newPageHeights = [];
        for (let i = 0; i < this.numberPageColumns; ++i) {
          newPageHeights.push(0);
        }
        this.pageColumnHeights.push(newPageHeights);
      }

      /**
       * Determines whether or not adding the month plan to the currentPage
       * will cause the page to overflow.
       */
      canAddMonthPlanToPage_(pageIndex, monthPlan) {
        const columnHeights = this.pageColumnHeights[pageIndex].map(x => x);
        let currentColumn = this.getCurrentColumnIndex_(columnHeights);

        for (const element of monthPlan) {
          if (columnHeights[currentColumn] == 0) {
            element.classList.add('startOfColumn');
          }
          if (!this.canAddElementToColumn_(
                  element, pageIndex, columnHeights[currentColumn])) {
            currentColumn += 1;
            element.classList.add('startOfColumn');
          }
          const elementHeight = getElementHeight(element);
          element.classList.remove('startOfColumn');
          if (currentColumn + 1 > this.numberPageColumns) {
            return false;
          }
          columnHeights[currentColumn] += elementHeight;
        }
        return true;
      }

      /**
       * Adds the month plan elements to the last page element. Assumes that
       * doing so will not cause the page to overflow.
       */
      addMonthPlanToPage_(pageIndex, monthPlan) {
        const page = this.pages[pageIndex];
        const columnHeights = this.pageColumnHeights[pageIndex];
        let currentColumn =
            this.getCurrentColumnIndex_(columnHeights);

        for (const element of monthPlan) {
          const currentColumnHeight = columnHeights[currentColumn];
          if (currentColumnHeight === 0) {
            element.classList.add('startOfColumn');
          }
          if (!this.canAddElementToColumn_(
                  element, pageIndex, currentColumnHeight)) {
            this.addSpacerToPage_(pageIndex, currentColumn);
            currentColumn += 1;
            element.classList.add('startOfColumn');
          }
          columnHeights[currentColumn] += getElementHeight(element);
          page.append(element);
        }
        return true;
      }

      canAddElementToColumn_(element, pageIndex, columnHeight) {
        const elementHeight = getElementHeight(element);
        const distanceToBottom =
            this.getPageHeight_(pageIndex) - columnHeight;
        const isYearHeader =
            element.classList.contains('readingPlanYearHeader');
        const isMonthHeader =
            element.classList.contains('readingPlanMonthHeader');
        return distanceToBottom >= elementHeight &&
                   (!isYearHeader || distanceToBottom >= 300) &&
                       (!isMonthHeader || distanceToBottom >= 100);
      }

      addSpacerToPage_(pageIndex, columnIndex) {
        const distanceToBottom =
            this.getPageHeight_(pageIndex) -
                this.pageColumnHeights[pageIndex][columnIndex];
        const spacerElement = createElement('div');
        $(spacerElement).css('height', `${distanceToBottom}px`);
        $(spacerElement).css('width', '250px');
        this.pages[pageIndex].append(spacerElement);
      }

      getPageHeight_(pageIndex) {
        return pageIndex === 0 ? this.firstPageHeight : this.pageHeight;
      }

      getCurrentColumnIndex_(pageColumnHeights) {
        let index = 0;
        for(let currentIndex = 0;
            currentIndex < pageColumnHeights.length;
            currentIndex += 1) {
          if (pageColumnHeights[currentIndex] > 0) {
            index = currentIndex;
          }
        }
        return index;
      }
    };

    function changeDate(inputId, newDateInput=null) {
      if (newDateInput) {
        $(inputId).val(newDateInput);
      }
      const newDate = new Date($(inputId).val());
      if (inputId === '#startingDate') {
        startingDate = newDate;
      } else {
        endingDate = newDate;
      }
      updateDateSuggestionButtons();
      checkDateValidity();
      updatePlanDurationText();
    }

    function suggestDate(buttonId) {
      const newDateInput = getDateInputVal(getSuggestedDate(buttonId));
      changeDate(
        buttonId === '#suggestStartingDateButton' ? 
            '#startingDate' : '#endingDate',
        newDateInput);
    }

    function submitForm() {
      populatePlanView();
      $('#readingPlanView').css('display', 'block');
      $('#mainView').css('display', 'none');
    }

    function testPlanView() {
      toggleAllCheckboxes(true);
      suggestDate('#suggestEndingDateButton');
      submitForm();
    }

    function getElementHeight(element) {
      if (GET_ESTIMATED_ELEMENT_HEIGHT) {
        if (element.classList.contains('readingPlanYearHeader')) {
          return element.classList.contains('startOfColumn') ?
                     READING_PLAN_YEAR_HEADER_START_OF_COLUMN_HEIGHT :
                     READING_PLAN_YEAR_HEADER_HEIGHT;
        }
        if (element.classList.contains('readingPlanMonthHeader')) {
          return element.classList.contains('startOfColumn') ?
                     READING_PLAN_MONTH_HEADER_START_OF_COLUMN_HEIGHT :
                     READING_PLAN_MONTH_HEADER_HEIGHT;
        }
        const numberTextLines =
            ($(element).find('.readingPlanEntryReading').html()
                 .match(new RegExp('<br>', 'g')) || []).length + 1;
        return numberTextLines * READING_PLAN_ENTRY_LINE_HEIGHT
                   + READING_PLAN_ENTRY_PADDING;
      }
      element.classList.add('hiddenForMeasurement');
      $('#measuringSpace').append(element);
      const height = element.scrollHeight;
      element.parentElement.removeChild(element);
      element.classList.remove('hiddenForMeasurement');
      return height;
    }

    $('.bookCheckbox .checkboxLabel').click(function(event) {
      toggleCheckbox($(this).parent().find('input'));
      onCheckboxToggled();
    });
    $('.bookCheckbox input').change(function(event) {
      onCheckboxToggled();
    });
    $('#checkAllButton').click(() => toggleAllCheckboxes(true));
    $('#uncheckAllButton').click(() => toggleAllCheckboxes(false));

    $('#startingDate').change(() => changeDate('#startingDate'));
    $('#endingDate').change(() => changeDate('#endingDate'));
    $('#suggestStartingDateButton').click(
        () => suggestDate('#suggestStartingDateButton'));
    $('#suggestEndingDateButton').click(
        () => suggestDate('#suggestEndingDateButton'));

    $('#parallelPsalmsCheckbox .checkboxLabel').click(function(event) {
      toggleCheckbox($(this).parent().find('input'));
      parallelPsalmsToggled();
    });

    $('#parallelPsalmsCheckbox input').change(function(event) {
      parallelPsalmsToggled();
    });

    $('#dailyPsalmsCheckbox .checkboxLabel').click(function(event) {
      toggleCheckbox($(this).parent().find('input'));
      dailyPsalmsToggled();
    });

    $('#dailyPsalmsCheckbox input').change(function(event) {
      dailyPsalmsToggled();
    });

    $('#submitButton').click(() => submitForm());

    $('#modifyButton').click(function(event) {
      $('#mainView').css('display', 'block');
      $('#readingPlanView').css('display', 'none');
      $([document.documentElement, document.body]).animate({
        scrollTop: $(".stepHeader").offset().top - 24
      }, 150, 'linear');
    });

    $('#printButton').click(function(event) {
      window.print();
    });
  </script>
</body>
</html>